<html>
<head>
	<title>CSS Icon Builder</title>
	<link rel="stylesheet" href="./style/style.css" type="text/css"/>
	<link rel="stylesheet" href="./style/icons.css" type="text/css"/>
	<link rel="stylesheet" href="./style/input.css" type="text/css"/>
	<script type="text/javascript" src="./script/ruleCross.js"></script>
	<script type="text/javascript" src="./script/drawShapes.js"></script>
	<script type="text/javascript">
	var canvas;
	var context;
	var animationID;

	var iconData = {
		"main":{
			"baseShape":"rectangle",
			"borderRadius":0,
			"borderRadiusType":null,
			"position": {"x":20, "y":20},
			"size": {"x":200, "y":200}
		},
		"before":{},
		"after":{}
	};

	// cursor x y
	var x, y;
	// x and y from the top left of shape
	var xOffset, yOffset;
	var clickDown = false;
	// 0 = main, 1 = before, 2 = after
	var currLayer = 0;
	var currClickShape = null;
	var currAnchorPos = null;
	var currClickAnchor = null;
	// x and y moved
	var xDelta = 0, yDelta = 0, wDelta = 0, hDelta = 0;
	// store temporary data
	var movingData;

	var WIDTH = 500;
	var HEIGHT = 500;
	var RULER_SIZE = 20;

	function start() {
		canvas = document.getElementById("editor");
		canvas.onmousedown = mouseDown;
		canvas.onmouseup = mouseUp;
		canvas.onmousemove = mouseMove;
		canvas.onmouseout = mouseOut;
		context = canvas.getContext("2d");
		drawCorner();
		drawHorizontalRuler();
		drawVerticalRuler();
		animationID = requestAnimationFrame(draw);
	}

	function draw() {
		context.clearRect(RULER_SIZE, RULER_SIZE, WIDTH, HEIGHT);

		drawIconMain();
		drawCrosshairs();

		animationID = requestAnimationFrame(draw);
	}


	function drawIconMain() {
		var mainData = iconData.main;
		if (mainData.baseShape == "rectangle") {
			context.fillStyle = "#000";
			if (mainData.borderRadiusType == "em") {
				drawRoundedRect(RULER_SIZE+mainData.position.x+xDelta, RULER_SIZE+mainData.position.y+yDelta, mainData.size.x+wDelta, mainData.size.y+hDelta, mainData.borderRadius, mainData.borderRadius);
				context.fill();
			} else if (mainData.borderRadiusType == "%") {
				drawRoundedRect(RULER_SIZE+mainData.position.x+xDelta, RULER_SIZE+mainData.position.y+yDelta, mainData.size.x+wDelta, mainData.size.y+hDelta, mainData.borderRadius*(mainData.size.x+wDelta), mainData.borderRadius*(mainData.size.y+hDelta));
				context.fill();
			} else {
				// normal rectangle
				drawRoundedRect(RULER_SIZE+mainData.position.x+xDelta, RULER_SIZE+mainData.position.y+yDelta, mainData.size.x+wDelta, mainData.size.y+hDelta, 0, 0);
				context.fill();
			}
		}
		if (currAnchorPos != null) {
			context.strokeStyle = "#48B8E0";
			context.fillStyle = "#FFF";
			context.beginPath();
			for (var anchor in currAnchorPos) {
				context.rect(RULER_SIZE+currAnchorPos[anchor][0]+xDelta + (anchor.indexOf("e")>=0?wDelta:0)+((anchor=="n"||anchor=="s")?wDelta/2:0),
				RULER_SIZE+currAnchorPos[anchor][1]+yDelta + (anchor.indexOf("s")>=0?hDelta:0)+((anchor=="e"||anchor=="w")?hDelta/2:0),
				6, 6);
			}
			context.fill();
			context.stroke();
		}
	}




	function mouseDown(e) {
		x = e.pageX - canvas.offsetLeft - RULER_SIZE;
		y = e.pageY - canvas.offsetTop - RULER_SIZE;

		clickDown = true;
		for (var anchor in currAnchorPos) {
			if (x-currAnchorPos[anchor][0] <= 6 && x-currAnchorPos[anchor][0] >= 0 &&
				y-currAnchorPos[anchor][1] <= 6 && y-currAnchorPos[anchor][1] >= 0) {
					currClickAnchor = anchor;
					// use to store click down position
					xOffset = x;
					yOffset = y;
					// TODO move to mousemove (when hover)
					document.body.style.cursor = anchor+"-resize";
					document.getElementById("sizeX").disabled = true;
					document.getElementById("sizeY").disabled = true;
				}
			}

			if (currClickAnchor == null) {
				if (currLayer == 0) {
					var mainData = iconData.main;
					if (mainData.baseShape == "rectangle") {
						if (mainData.borderRadiusType == "em") {
							drawRoundedRect(RULER_SIZE+mainData.position.x+xDelta, RULER_SIZE+mainData.position.y+yDelta, mainData.size.x+wDelta, mainData.size.y+hDelta, mainData.borderRadius, mainData.borderRadius);
						} else if (mainData.borderRadiusType == "%") {
							drawRoundedRect(RULER_SIZE+mainData.position.x+xDelta, RULER_SIZE+mainData.position.y+yDelta, mainData.size.x+wDelta, mainData.size.y+hDelta, mainData.borderRadius*(mainData.size.x+wDelta), mainData.borderRadius*(mainData.size.y+hDelta));
						} else {
							// normal rectangle
							drawRoundedRect(RULER_SIZE+mainData.position.x+xDelta, RULER_SIZE+mainData.position.y+yDelta, mainData.size.x+wDelta, mainData.size.y+hDelta, 0, 0);
						}
					}
					if (context.isPointInPath(RULER_SIZE+x, RULER_SIZE+y)) {
						currClickShape = "main";
						currAnchorPos = {"nw":[mainData.position.x-3, mainData.position.y-3],
						"n":[mainData.position.x+mainData.size.x/2-3, mainData.position.y-3],
						"ne":[mainData.position.x+mainData.size.x-3, mainData.position.y-3],
						"w":[mainData.position.x-3, mainData.position.y+mainData.size.y/2-3],
						"e":[mainData.position.x+mainData.size.x-3, mainData.position.y+mainData.size.y/2-3],
						"sw":[mainData.position.x-3, mainData.position.y+mainData.size.y-3],
						"s":[mainData.position.x+mainData.size.x/2-3, mainData.position.y+mainData.size.y-3],
						"se":[mainData.position.x+mainData.size.x-3, mainData.position.y+mainData.size.y-3]};
						xOffset = mainData.position.x - x;
						yOffset = mainData.position.y - y;
						movingData = {"position": mainData.position, "size": mainData.size};
						document.getElementById("posX").value = mainData.position.x/WIDTH + "em";
						document.getElementById("posX").disabled = true;
						document.getElementById("posY").value = mainData.position.y/HEIGHT + "em";
						document.getElementById("posY").disabled = true;
						document.getElementById("sizeX").value = iconData.main.size.x/WIDTH + "em";
						document.getElementById("sizeY").value = iconData.main.size.y/HEIGHT + "em";
						document.getElementById("bRadius").value = (iconData.main.borderRadiusType=="%"?iconData.main.borderRadius*100:iconData.main.borderRadius/WIDTH) + iconData.main.borderRadiusType;
					} else {
						// reset things
						currClickShape = null;
						currAnchorPos = null;
						xOffset = 0;
						yOffset = 0;
						document.getElementById("posX").value = "";
						document.getElementById("posY").value = "";
						document.getElementById("sizeX").value = "";
						document.getElementById("sizeY").value = "";
						document.getElementById("bRadius").value = "";
					}
				}
			}
		}

		function mouseUp(e) {
			clickDown = false;
			if (currLayer == 0) {
				if (currClickShape == "main") {
					// Apply delta to data
					iconData.main.position.x += xDelta;
					document.getElementById("posX").value = iconData.main.position.x/WIDTH + "em";
					document.getElementById("posX").disabled = false;
					iconData.main.position.y += yDelta;
					document.getElementById("posY").value = iconData.main.position.y/HEIGHT + "em";
					document.getElementById("posY").disabled = false;
					iconData.main.size.x += wDelta;
					document.getElementById("sizeX").value = iconData.main.size.x/WIDTH + "em";
					document.getElementById("sizeX").disabled = false;
					iconData.main.size.y += hDelta;
					document.getElementById("sizeY").value = iconData.main.size.y/WIDTH + "em";
					document.getElementById("sizeY").disabled = false;
					for (var anchor in currAnchorPos) {
						currAnchorPos[anchor][0] += xDelta + (anchor.indexOf("e")>=0?wDelta:0)+((anchor=="n"||anchor=="s")?wDelta/2:0);
						currAnchorPos[anchor][1] += yDelta + (anchor.indexOf("s")>=0?hDelta:0)+((anchor=="e"||anchor=="w")?hDelta/2:0);
					}
				}
			}
			xDelta = 0;
			yDelta = 0;
			wDelta = 0;
			hDelta = 0;
			xOffset = 0;
			yOffset = 0;
			currClickAnchor = null;
		}

		function mouseMove(e) {
			x = e.pageX - canvas.offsetLeft - RULER_SIZE;
			y = e.pageY - canvas.offsetTop - RULER_SIZE;

			//TODO fixed when out of border (should allow)
			if (clickDown) {
				if (currClickAnchor != null) {
					switch (currClickAnchor) {
						case "n":
						yDelta = y - yOffset;
						hDelta = yOffset - y;
						break;
						case "ne":
						wDelta = x - xOffset;
						yDelta = y - yOffset;
						hDelta = yOffset - y;
						break;
						case "nw":
						xDelta = x - xOffset;
						wDelta = xOffset - x;
						yDelta = y - yOffset;
						hDelta = yOffset - y;
						break;
						case "w":
						xDelta = x - xOffset;
						wDelta = xOffset - x;
						break;
						case "e":
						wDelta = x - xOffset;
						break;
						case "s":
						hDelta = y - yOffset;
						break;
						case "se":
						wDelta = x - xOffset;
						hDelta = y - yOffset;
						break;
						case "sw":
						xDelta = x - xOffset;
						wDelta = xOffset - x;
						hDelta = y - yOffset;
						break;
					}
				} else if (currClickShape != null) {
					if (x+xOffset >= 0) {
						xDelta = x+xOffset - movingData.position.x;
					}
					if (y+yOffset >= 0) {
						yDelta = y+yOffset - movingData.position.y;
					}
				}
			}
		}

		function mouseOut(e) {
			// TODO fix mouseout behaviour
			clickDown = false;
			x = 0;
			y = 0;
		}


		function changePosX(value) {
			if (value.indexOf("em") >= 0) {
				value = value.substr(0, value.indexOf("em"))*WIDTH;
				if (currLayer == 0) {
					if (currClickShape == "main") {
						xDelta = value - iconData.main.position.x;
						mouseUp();
					}
				}
			}
		}
		function changePosY(value) {
			if (value.indexOf("em") >= 0) {
				value = value.substr(0, value.indexOf("em"))*HEIGHT;
				if (currLayer == 0) {
					if (currClickShape == "main") {
						yDelta = value - iconData.main.position.y;
						mouseUp();
					}
				}
			}
		}
		function changeSizeX(value) {
			if (value.indexOf("em") >= 0) {
				value = value.substr(0, value.indexOf("em"))*WIDTH;
				if (currLayer == 0) {
					if (currClickShape == "main") {
						wDelta = value - iconData.main.size.x;
						mouseUp();
					}
				}
			}
		}
		function changeSizeY(value) {
			if (value.indexOf("em") >= 0) {
				value = value.substr(0, value.indexOf("em"))*HEIGHT;
				if (currLayer == 0) {
					if (currClickShape == "main") {
						hDelta = value - iconData.main.size.y;
						mouseUp();
					}
				}
			}
		}

		function changeBRadius(value) {
			// TODO add individual corner
			if (value.indexOf("em") >= 0) {
				value = value.substr(0, value.indexOf("em"));
				if (currLayer == 0) {
					if (currClickShape == "main") {
						iconData.main.borderRadius = value*WIDTH;
						iconData.main.borderRadiusType = "em";
					}
				}
			} else if (value.indexOf("%") >= 0) {
				value = value.substr(0, value.indexOf("%"));
				if (currLayer == 0) {
					if (currClickShape == "main") {
						iconData.main.borderRadius = value/100;
						iconData.main.borderRadiusType = "%";
					}
				}
			}
		}

		</script>
	</head>

	<body>
		<header>
			<h1>CSS Icon Builder</h1>
		</header>

		<nav>
			<div>File</div>
			<div>Help</div>
		</nav>

		<aside class="tools">
			<div title="Rectangle"><i class="tool_icon_rectangle"></i></div>
			<div title="Circle"><i class="tool_icon_circle"></i></div>
		</aside>

		<div class="centerArea">
			<canvas id="editor" width="520" height="520">
				Your browser doesn't support HTML5 canvas.
			</canvas>
		</div>

		<aside class="panels">
			<section id="layers">
				<h2>Layers</h2>
				<div>Main Layer</div>
				<div>:before Layer</div>
				<div>:after Layer</div>
			</section>

			<section id="properties">
				<h2>Properties</h2>
				<div class="posSize">
					<label for="posX">X:</label><input type="text" id="posX" onchange="changePosX(this.value)"/>
					<label for="posY">Y:</label><input type="text" id="posY" onchange="changePosY(this.value)"/><br/>
					<label for="sizeX">W:</label><input type="text" id="sizeX" onchange="changeSizeX(this.value)"/>
					<label for="sizeY">H:</label><input type="text" id="sizeY" onchange="changeSizeY(this.value)"/>
				</div>
				<div id="rectangle">
					<label for="bRadius">Border Radius:</label><input type="text" id="bRadius" onchange="changeBRadius(this.value)"/>
				</div>
				<div class="color">
					<label for="bgColor">Background:</label><input type="color" id="bgColor"/><br/>
					<label for="boColor">Border:</label><input type="color" id="boColor"/>
				</div>
			</section>
		</aside>

		<script type="text/javascript">
		start();
		</script>
	</body>

	</html>
