<html>
<head>
	<title>CSS Icon Builder</title>
	<link rel="stylesheet" href="./style/style.css" type="text/css"/>
	<link rel="stylesheet" href="./style/icons.css" type="text/css"/>
	<link rel="stylesheet" href="./style/input.css" type="text/css"/>
	<script type="text/javascript" src="./script/ruleCross.js"></script>
	<script type="text/javascript">
	var canvas;
	var context;
	var animationID;

	var iconData = {
		"main":{
			"baseShape":"rectangle",
			"borderRadius":0,
			"position": {"x":20, "y":20},
			"size": {"x":200, "y":100}
		},
		"before":{},
		"after":{}
	};

	var x, y;
	var xOffset, yOffset;
	var clickDown = false;
	// 0 = main, 1 = before, 2 = after
	var currLayer = 0;
	var currClickShape = null;
	var currAnchorPos = null;
	var xDelta = 0, yDelta = 0;
	var movingData;

	var WIDTH = 500;
	var HEIGHT = 500;
	var RULER_SIZE = 20;

	function start() {
		canvas = document.getElementById("editor");
		canvas.onmousedown = mouseDown;
		canvas.onmouseup = mouseUp;
		canvas.onmousemove = mouseMove;
		canvas.onmouseout = mouseOut;
		context = canvas.getContext("2d");
		drawCorner();
		drawHorizontalRuler();
		drawVerticalRuler();
		animationID = requestAnimationFrame(draw);
	}

	function draw() {
		context.clearRect(RULER_SIZE, RULER_SIZE, WIDTH, HEIGHT);
		/*if (clickDown) {
			drawRect(x, y, "#5AE09E");
		} else {
			drawRect(xBox, yBox, "#5AE09E");
		}*/

		drawIconMain();
		drawCrosshairs();

		animationID = requestAnimationFrame(draw);
	}


	function drawIconMain() {
		var mainData = iconData.main;
		if (mainData.baseShape == "rectangle") {
			if (mainData.borderRadius == 0) {
				context.fillStyle = "#000";
				context.beginPath();
				context.rect(RULER_SIZE+mainData.position.x+xDelta, RULER_SIZE+mainData.position.y+yDelta, mainData.size.x, mainData.size.y);
				context.fill();
			}
		}
		if (currAnchorPos != null) {
			context.strokeStyle = "#48B8E0";
			context.fillStyle = "#FFF";
			context.beginPath();
			for (var anchor in currAnchorPos) {
				context.rect(RULER_SIZE+currAnchorPos[anchor][0]+xDelta, RULER_SIZE+currAnchorPos[anchor][1]+yDelta, 6, 6);
			}
			context.fill();
			context.stroke();
		}
	}




	function mouseDown(e) {
		clickDown = true;
		if (currLayer == 0) {
			var mainData = iconData.main;
			context.beginPath();
			context.rect(RULER_SIZE+mainData.position.x, RULER_SIZE+mainData.position.y, mainData.size.x, mainData.size.y);
			if (context.isPointInPath(e.pageX-canvas.offsetLeft, e.pageY-canvas.offsetTop)) {
				currClickShape = "main";
				currAnchorPos = {"tl":[mainData.position.x-3, mainData.position.y-3],
								 "t":[mainData.position.x+mainData.size.x/2-3, mainData.position.y-3],
				 				 "tr":[mainData.position.x+mainData.size.x-3, mainData.position.y-3],
								 "l":[mainData.position.x-3, mainData.position.y+mainData.size.y/2-3],
								 "r":[mainData.position.x+mainData.size.x-3, mainData.position.y+mainData.size.y/2-3],
								 "bl":[mainData.position.x-3, mainData.position.y+mainData.size.y-3],
								 "b":[mainData.position.x+mainData.size.x/2-3, mainData.position.y+mainData.size.y-3],
								 "br":[mainData.position.x+mainData.size.x-3, mainData.position.y+mainData.size.y-3]};
				xOffset = (RULER_SIZE+mainData.position.x) - (e.pageX-canvas.offsetLeft);
				yOffset = (RULER_SIZE+mainData.position.y) - (e.pageY-canvas.offsetTop);
				movingData = {"position": mainData.position, "size": mainData.size};
				document.getElementById("posX").value = mainData.position.x/WIDTH + "em";
				document.getElementById("posX").disabled = true;
				document.getElementById("posY").value = mainData.position.y/HEIGHT + "em";
				document.getElementById("posY").disabled = true;
			} else {
				currClickShape = null;
				currAnchorPos = null;
				xOffset = 0;
				yOffset = 0;
			}
		}
		mouseMove(e);
	}

	function mouseUp(e) {
		clickDown = false;
		if (currLayer == 0) {
			if (currClickShape == "main") {
				iconData.main.position.x += xDelta;
				document.getElementById("posX").value = iconData.main.position.x/WIDTH + "em";
				document.getElementById("posX").disabled = false;
				iconData.main.position.y += yDelta;
				document.getElementById("posY").value = iconData.main.position.y/HEIGHT + "em";
				document.getElementById("posY").disabled = false;
				for (var anchor in currAnchorPos) {
					currAnchorPos[anchor][0] += xDelta;
					currAnchorPos[anchor][1] += yDelta;
				}
				xDelta = 0;
				yDelta = 0;
			}
		}
	}

	function mouseMove(e) {
		x = e.pageX - canvas.offsetLeft - RULER_SIZE;
		y = e.pageY - canvas.offsetTop - RULER_SIZE;

		//TODO fixed when out of border (should allow)
		if (clickDown) {
			if (currClickShape != null) {
				if (x+xOffset >= 0) {
					xDelta = x+xOffset - movingData.position.x;
				}
				if (y+yOffset >= 0) {
					yDelta = y+yOffset - movingData.position.y;
				}
			}
		}
	}

	function mouseOut(e) {
		clickDown = false;
		x = 0;
		y = 0;
	}

	</script>
</head>

<body>
	<header>
		<h1>CSS Icon Builder</h1>
	</header>

	<nav>
		<div>File</div>
		<div>Help</div>
	</nav>

	<aside class="tools">
		<div title="Rectangle"><i class="tool_icon_rectangle"></i></div>
		<div title="Circle"><i class="tool_icon_circle"></i></div>
	</aside>

	<div class="centerArea">
		<canvas id="editor" width="520" height="520">
			Your browser doesn't support HTML5 canvas.
		</canvas>
	</div>

	<aside class="panels">
		<section id="layers">
			<h2>Layers</h2>
			<div>Main Layer</div>
			<div>:before Layer</div>
			<div>:after Layer</div>
		</section>

		<section id="properties">
			<h2>Properties</h2>
			<div class="posSize">
				<label for="posX">X:</label><input type="text" id="posX"/>
				<label for="posY">Y:</label><input type="text" id="posY"/><br/>
				<label for="sizeX">W:</label><input type="text" id="sizeX"/>
				<label for="sizeY">H:</label><input type="text" id="sizeY"/>
			</div>
			<div class="color">
				<label for="bgColor">Background:</label><input type="color" id="bgColor"/><br/>
				<label for="boColor">Border:</label><input type="color" id="boColor"/>
			</div>
		</section>
	</aside>

	<script type="text/javascript">
	start();
	</script>
</body>

</html>
